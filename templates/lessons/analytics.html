<div class="row mb-4" style="width:1100px;max-width:1100px;min-width:1100px;margin:0 auto; position:relative;">
    <!-- Thêm khung thống kê 30 ngày -->
    <div class="card shadow-sm mb-4 p-4">
        <div class="row mb-4">
            <div class="col text-start">
                <span class="fs-5">Trong 30 ngày gần đây, Peter đã...</span>
            </div>
        </div>
        <div class="row text-center mb-4 position-relative">
            <div class="col position-relative">
            <div class="mb-2">
                <img src="https://img.icons8.com/ios-filled/32/4caf50/pencil-tip.png" alt="Answered">
            </div>
            <div class="text-muted">Đã trả lời</div>
            <div class="fw-bold fs-3"><?= htmlspecialchars($totalAnswers) ?></div>
            <div class="text-muted">câu hỏi</div>
            <div class="vr d-none d-md-block" style="position:absolute;top:10%;right:0;height:80%;width:4px;background:#b0b0b0;"></div>
            </div>
            <div class="col position-relative">
            <div class="mb-2">
                <img src="https://img.icons8.com/ios-filled/32/2196f3/clock--v1.png" alt="Spent">
            </div>
            <div class="text-muted">Đã dành</div>
            <div class="fw-bold fs-4"><?= htmlspecialchars($time['hours']) ?> Giờ <?= htmlspecialchars($time['minutes']) ?> Phút</div>
            <div class="text-muted">học tập</div>
            <div class="vr d-none d-md-block" style="position:absolute;top:10%;right:0;height:80%;width:4px;background:#b0b0b0;"></div>
            </div>
            <div class="col">
            <div class="mb-2">
                <img src="https://img.icons8.com/ios-filled/32/f9a825/puzzle.png" alt="Progress">
            </div>
            <div class="text-muted">Đã phát triễn</div>
            <div class="fw-bold fs-3"><?= htmlspecialchars($totalLessons) ?></div>
            <div class="text-muted">kỹ năng</div>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="fw-bold mb-2" style="color:#357abd; font-size: 1rem;">Luyện tập theo bài học</div>
                <div style="width:120px; margin:0 auto;">
                    <canvas id="categoryPie" width="120" height="120"></canvas>
                </div>
                <ul class="list-unstyled mt-2 small" style="font-size: 0.85rem;">
                    <?php
                        $labels = $topLessonIds;
                        $colors = [
                            '#4caf50',
                            '#2196f3',
                            '#fbc02d',
                            '#ff9800',
                            '#9c27b0',
                            '#bdbdbd'
                        ];
                        $total = array_sum($lessons);
                        foreach ($lessons as $i => $num) {
                            $percent = $total > 0 ? round($num * 100 / $total) : 0;
                            echo '<li><span style="color:' . $colors[$i] . ';">■</span> ' . $percent . '% ' . $labels[$i] . '</li>';
                        }
                    ?>
                </ul>
            </div>
            <div class="col-8">
                <div class="fw-bold mb-2" style="color:#357abd;">Luyện tập theo ngày</div>
                <div style="position: relative;">
                    <span style="position: absolute; left: -65px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-size: 0.95rem; color: #357abd; letter-spacing: 1px;">Số câu trả lời</span>
                    <canvas id="practiceBar" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Khung Sessions and skills -->
    <div class="card mb-4 p-3">
        <div class="row mb-4">
            <div class="col text-start">
                <span class="fs-5">Buổi học và kỹ năng</span>
            </div>
        </div>
        <div class="accordion" id="sessionsAccordion">
            <!-- 1 phiên học -->
            <div class="accordion-item border-0 mb-2">
                <h2 class="accordion-header" id="heading1">
                    <button class="accordion-button collapsed bg-secondary text-white px-3 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1" aria-expanded="false" aria-controls="collapse1" style="font-size:1rem;">
                        MONDAY, JUNE 16 | 2:12 – 2:32 PM
                        <span class="ms-auto small">2 skills practiced: 11 questions</span>
                    </button>
                </h2>
                <div id="collapse1" class="accordion-collapse collapse" aria-labelledby="heading1" data-bs-parent="#sessionsAccordion">
                    <div class="accordion-body bg-light">
                        <!-- Nội dung chi tiết phiên học (nếu có) -->
                        <span class="text-muted">No details available.</span>
                    </div>
                </div>
            </div>
            <!-- 2 -->
            <div class="accordion-item border-0 mb-2">
                <h2 class="accordion-header" id="heading2">
                    <button class="accordion-button collapsed bg-secondary text-white px-3 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2" aria-expanded="false" aria-controls="collapse2" style="font-size:1rem;">
                        MONDAY, JUNE 16 | 10:27 – 10:33 AM
                        <span class="ms-auto small">2 skills practiced: 5 questions</span>
                    </button>
                </h2>
                <div id="collapse2" class="accordion-collapse collapse" aria-labelledby="heading2" data-bs-parent="#sessionsAccordion">
                    <div class="accordion-body bg-light">
                        <span class="text-muted">No details available.</span>
                    </div>
                </div>
            </div>
            <!-- 3 -->
            <div class="accordion-item border-0 mb-2">
                <h2 class="accordion-header" id="heading3">
                    <button class="accordion-button collapsed bg-secondary text-white px-3 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3" aria-expanded="false" aria-controls="collapse3" style="font-size:1rem;">
                        SUNDAY, JUNE 15 | 9:21 – 11:24 PM
                        <span class="ms-auto small">4 skills practiced: 40 questions</span>
                    </button>
                </h2>
                <div id="collapse3" class="accordion-collapse collapse" aria-labelledby="heading3" data-bs-parent="#sessionsAccordion">
                    <div class="accordion-body bg-light">
                        <span class="text-muted">No details available.</span>
                    </div>
                </div>
            </div>
            <!-- 4 -->
            <div class="accordion-item border-0 mb-2">
                <h2 class="accordion-header" id="heading4">
                    <button class="accordion-button collapsed bg-secondary text-white px-3 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4" aria-expanded="false" aria-controls="collapse4" style="font-size:1rem;">
                        SUNDAY, JUNE 15 | 8:50 – 8:52 PM
                        <span class="ms-auto small">1 skill practiced: 9 questions</span>
                    </button>
                </h2>
                <div id="collapse4" class="accordion-collapse collapse" aria-labelledby="heading4" data-bs-parent="#sessionsAccordion">
                    <div class="accordion-body bg-light">
                        <span class="text-muted">No details available.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm Chart.js để vẽ biểu đồ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function initializeCharts() {
        // Kiểm tra xem canvas đã tồn tại chưa
        const piCanvas = document.getElementById('categoryPie');
        const barCanvas = document.getElementById('practiceBar');
        
        if (!piCanvas || !barCanvas) {
            return;
        }

        // Pie chart
        const ctxPie = piCanvas.getContext('2d');
        new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: [
                    'Counting to 100',
                    'Counting to 10',
                    'Comparing up to 10',
                    'Understand multiplication',
                    'Addition strategies',
                    'Other'
                ],
                datasets: [{
                    data: <?= json_encode($lessons) ?>,
                    backgroundColor: [
                        '#4caf50',
                        '#2196f3',
                        '#fbc02d',
                        '#ff9800',
                        '#9c27b0',
                        '#bdbdbd'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                plugins: { legend: { display: false } }
            }
        });

        // Bar chart
        const ctxBar = barCanvas.getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: <?= json_encode($date) ?>,
                datasets: [{
                    label: 'Questions answered',
                    data: <?= json_encode($datas) ?>,
                    backgroundColor: '#2196f3'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 700, ticks: { stepSize: 100 } }
                }
            }
        });
    }

    // Khởi tạo biểu đồ khi DOM ready
    document.addEventListener('DOMContentLoaded', initializeCharts);
    
    // Khởi tạo biểu đồ sau khi PJAX load
    document.addEventListener('pjax:complete', initializeCharts);
    
    // Fallback cho trường hợp script chạy sau khi DOM đã sẵn sàng
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCharts);
    } else {
        initializeCharts();
    }
</script>

